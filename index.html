<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>汉字 / 漢字 / Hàn Zì</title>
  <meta name="description" content="汉字 / 漢字 / Hàn Zì">

  <link rel="stylesheet" href="hanzi.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="chance.min.js"></script>
  <script src="lodash.min.js"></script>
  <script src="characters.json.min.js"></script>
  <script src="sentences.json.min.js"></script>
</head>

<body>
    <h1>汉字 / 漢字 / Hàn Zì</h1>
    <div>
        <select class="maxCharacters">
          <option value="10">10</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="500">500</option>
          <option value="1000" selected>1000</option>
          <option value="1499">1500</option>
        </select>
        most common characters.
    </div>
    <div class="characters"></div>
    <div class="sentence"></div>
    <div class="pinyinSentence"></div>
    <div class="englishSentence"></div>

    <div class="answers"></div>

    <div class="helpers">
        <div class="pinyin"></div>
        <div class="dash">-</div>
        <div class="english"></div>
    </div>
    
    <div class="scores">
        <div class="score pinyinScore">
          pinyin score: <div class="pinyinCorrect">0</div> / <div class="pinyinTotal">0</div>
        </div>
        <div class="score englishScore">
          meaning score: <div class="englishCorrect">0</div> / <div class="englishTotal">0</div>
        </div>
    </div>

    <div class="pastGames"></div>

  <script>
    $( document ).ready(() => {
        newGame();
    });
    $('.maxCharacters').on('change', ()=>{
        $('.pinyinCorrect').text("0");
        $('.pinyinTotal').text("0");
        $('.englishCorrect').text("0");
        $('.englishTotal').text("0");
        newGame()
    });
    let max = $(".maxCharacters").val();
    let sentence = {};
    let getQueryString = (field) => {
        let href = window.location.href;
        let reg = new RegExp( '[?&]' + field + '=([^&#]*)', 'i' );
        let string = reg.exec(href);
        return string ? string[1] : null;
    };
    let character = characters[chance.integer({min:1, max:max})];
    let newGame = () => {
        $('.english').html('');
        $('.pinyin').html('');
        $('.answers').html('');
        $('.englishSentence').html('');
        $('.pinyinSentence').html('');

        //set the character
        character = characters[chance.integer({min:1, max:max})];
        let displayCharacter = character.characters.simplfied;
        if (character.characters.tradtional !== character.characters.simplfied) {
            displayCharacter = character.characters.tradtional + " / " + character.characters.simplfied;
        }
        $('.characters').text(displayCharacter);

        //set the example sentence
        sentence = _.findKey(sentences, (s) => { return s.simplified.indexOf(character.characters.simplfied) >= 0; });
        let displaySentence = sentences[sentence].simplified;
        if (character.characters.tradtional !== character.characters.simplfied) {
            displaySentence = sentences[sentence].traditional + " / " + displaySentence;
        }
        $('.sentence').text(displaySentence);

        var answerButtons = [$('<button/>',
        {
            text: character.pinyin,
        }).click(() => answerPinyin(true)),
        $('<button/>',
        {
            text: characters[chance.integer({min:1, max:max})].pinyin,
        }).click(() => answerPinyin(false)),
        $('<button/>',
        {
            text: characters[chance.integer({min:1, max:max})].pinyin,
        }).click(() => answerPinyin(false)),
        $('<button/>',
        {
            text: characters[chance.integer({min:1, max:max})].pinyin,
        }).click(() => answerPinyin(false)),];

        $('.answers').append(shuffle(answerButtons));
    }

    let answerPinyin = (bool) => {
        let pinyinTotal = parseInt($('.pinyinTotal').text());
        $('.pinyinTotal').text(pinyinTotal + 1);
        $('.pinyin').css('color', '#f44336');
        if (bool) {
            let pinyinCorrect = parseInt($('.pinyinCorrect').text());
            $('.pinyinCorrect').text(pinyinCorrect + 1);
            $('.pinyin').css('color', '#4CAF50');
        }

        $('.pinyin').text(character.pinyin);

        //clear answers
        $('.answers').html('');

        //def answers
        var answerButtons = [$('<button/>',
        {
            text: character.definition,
        }).click(() => answerDef(true)),
        $('<button/>',
        {
            text: characters[chance.integer({min:1, max:max})].definition,
        }).click(() => answerDef(false)),
        $('<button/>',
        {
            text: characters[chance.integer({min:1, max:max})].definition,
        }).click(() => answerDef(false)),
        $('<button/>',
        {
            text: characters[chance.integer({min:1, max:max})].definition,
        }).click(() => answerDef(false)),];

        $('.answers').append(shuffle(answerButtons));
    }

    let answerDef = (bool) => {
        let englishTotal = parseInt($('.englishTotal').text());
        $('.englishTotal').text(englishTotal + 1);
        $('.english').css("color", "#f44336");
        if (bool) {
            let englishCorrect = parseInt($('.englishCorrect').text());
            $('.englishCorrect').text(englishCorrect + 1);
            $('.english').css("color", "#4CAF50");
        }

        $('.english').text(character.definition);
        $('.englishSentence').text(sentences[sentence].english);
        $('.pinyinSentence').text(sentences[sentence].pinyin);

        let pastGames = character.characters.simplfied + " " + character.pinyin + " -  " + character.definition;
        if (character.characters.simplfied !== character.characters.tradtional){
            pastGames = character.characters.tradtional + "/" + character.characters.simplfied + " " + character.pinyin + " - " + character.definition;
        }
        

        $('.pastGames').append($('<div></div>').text(pastGames))
        //clear answers
        $('.answers').html($('<button/>',
        {
            text: "Next",
        }).click(() => newGame()));
    }

    let shuffle = (array) => {
      var currentIndex = array.length, temporaryValue, randomIndex;

      // While there remain elements to shuffle...
      while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }
  </script>
</body>
</html>